'''
Crear una red bayesiana desde un fichero bif
'''

from pgmpy.readwrite import BIFReader
from pgmpy.readwrite import BIFWriter
from pgmpy.inference import VariableElimination
from pgmpy.models import BayesianNetwork
from pgmpy.factors.discrete import TabularCPD

reader = BIFReader("cancer.bif")

model = reader.get_model()

# Acceder a los elementos del modelo
var = reader.get_variables()
valores = reader.get_states()
edges = reader.get_edges()
cpds = reader.get_values()

print(f"Variables en el modelo: {var} \n")
print(f"Valores de la variables en el modelo: {valores} \n")
print(f"Aristas en el modelo: {edges} \n")
print(f"CPDs en el modelo: {cpds} \n")

# Imprimir el modelo en fichero bif

writer = BIFWriter(model)
writer.write_bif('cancerW.bif')

# Inferencia por eliminación de variables 

model_infer = VariableElimination(model)

# Calcular la probabilidad de Cancer dado Fumador = verdad

q = model_infer.query(variables=['Cancer'], evidence={'Fumador':'verdad'})
print(q)


----------------------------------------

'''
Definir una red bayesiana en pgmpy supone los siguientes pasos:

Definir la estructura de la red
Definir los parámetros (CPDs)
Asociar los CPDs con la red. 
'''

from pgmpy.models import BayesianNetwork
from pgmpy.factors.discrete import TabularCPD


# Definir la estructura de la red

cancer_model = BayesianNetwork(
    [
        ("Polucion", "Cancer"),
        ("Fumador", "Cancer"),
        ("Cancer", "Radiografia"),
        ("Cancer", "Disnea"),
    ]
)

# Definir los parámetros (CPDs)
# La librería asigna 0 al primer valor de probabilidad y 1 al segundo: 0 con 0.9 y 1 con 0.1

cpd_pol = TabularCPD(variable="Polucion", variable_card=2, values=[[0.9], [0.1]])
cpd_fum = TabularCPD(variable="Fumador", variable_card=2, values=[[0.3], [0.7]])
cpd_cancer = TabularCPD(
    variable="Cancer",
    variable_card=2,
    values=[[0.03, 0.05, 0.001, 0.02], [0.97, 0.95, 0.999, 0.98]],
    evidence=["Fumador", "Polucion"],
    evidence_card=[2, 2],
)
cpd_rad = TabularCPD(
    variable="Radiografia",
    variable_card=2,
    values=[[0.9, 0.2], [0.1, 0.8]],
    evidence=["Cancer"],
    evidence_card=[2],
)

cpd_dis = TabularCPD(
    variable="Disnea",
    variable_card=2,
    values=[[0.65, 0.3], [0.35, 0.7]],
    evidence=["Cancer"],
    evidence_card=[2],
)

# Asociar los CPDs con la red. 
cancer_model.add_cpds(cpd_pol, cpd_fum, cpd_cancer, cpd_rad, cpd_dis)

# Comprobar si el modelo se ha construido correctamente
cancer_model.check_model()

-----------------------------------------

# Acceder a los elementos del modelo
nodes = cancer_model.nodes()
edges = cancer_model.edges()
cpds = cancer_model.get_cpds()


print(f"Nodes in the model: {nodes} \n")
print(f"Edges in the model: {edges} \n")
print(f"CPDs in the model: ")
for cpd in cancer_model.get_cpds():
    print(cpd)

-----------------------------------------

# Inferencia por eliminación de variables 

from pgmpy.inference import VariableElimination

cancer_infer = VariableElimination(cancer_model)

# Calcular la probabilidad de Cancer dado Fumador = verdad/0

q = cancer_infer.query(variables=['Cancer'], evidence={'Fumador':0})
print(q)


# Calcular la probabilidad conjunta de Cancer y Disnea dado Fumador = falso/1
q = cancer_infer.query(variables=["Cancer", "Disnea"], evidence={"Fumador": 1})
print(q)

# Calcular las probabilidades (no conjuntas) de Cancer y Disnea dado Fumador = verdad/0
q = cancer_infer.query(variables=["Cancer", "Disnea"], evidence={"Fumador": 0}, joint=False)
for factor in q.values():
    print(factor)

